name: Docker Image CI

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for proper tag detection

      # Set up git for tagging
      - name: Configure Git
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

      # Determine the next semantic version
      - name: Get next version
        id: version
        run: |
          # Get the latest tag, defaulting to 1.0.0 if none exists
          LATEST_TAG=$(git tag -l --sort=-v:refname | head -n 1)
          
          if [ -z "$LATEST_TAG" ]; then
            # If no tags exist, start with 1.0.1
            NEW_VERSION="1.0.1"
          else
            # Parse the latest tag and increment the patch version
            MAJOR=$(echo $LATEST_TAG | cut -d. -f1 | sed 's/v//g')
            MINOR=$(echo $LATEST_TAG | cut -d. -f2)
            PATCH=$(echo $LATEST_TAG | cut -d. -f3)
            
            # Increment patch version
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          fi
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      # Build the Docker image with the new version
      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag nayem9b/bookify-client-github-build:${{ steps.version.outputs.new_version }}

      # Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # Push the versioned image
      - name: Push versioned image
        run: docker push nayem9b/bookify-client-github-build:${{ steps.version.outputs.new_version }}

      # Push the 'latest' tag as well
      - name: Push latest image
        run: |
          docker tag nayem9b/bookify-client-github-build:${{ steps.version.outputs.new_version }} nayem9b/bookify-client-github-build:latest
          docker push nayem9b/bookify-client-github-build:latest

      # Create git tag for the new version
      - name: Create Git tag
        run: |
          git tag ${{ steps.version.outputs.new_version }}
          git push origin ${{ steps.version.outputs.new_version }}
